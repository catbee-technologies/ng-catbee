name: üì¶ Publish Angular Packages

on:
  push:
    tags:
      - 'utils@v*.*.*'
      - 'monaco@v*.*.*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Determine which package to publish
        id: detect
        run: |
          REF=${GITHUB_REF_NAME}
          echo "Detected tag: $REF"
          if [[ "$REF" == utils@v* ]]; then
            echo "package=utils" >> $GITHUB_OUTPUT
          elif [[ "$REF" == monaco@v* ]]; then
            echo "package=monaco-editor" >> $GITHUB_OUTPUT
          else
            echo "Unknown tag format: $REF"
            exit 1
          fi

      - name: üõ†Ô∏è Build the selected package
        run: npm run build ${{ steps.detect.outputs.package }}

      - name: üßπ Prepare package.json for publish
        run: |
          PKG_PATH=dist/@ng-catbee/${{ steps.detect.outputs.package }}
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('$PKG_PATH/package.json', 'utf8'));
          delete pkg.devDependencies;
          delete pkg.scripts;
          fs.writeFileSync('$PKG_PATH/package.json', JSON.stringify(pkg, null, 2));
          console.log('Cleaned package.json for publish');
          "

      - name: üöÄ Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_PATH=dist/@ng-catbee/${{ steps.detect.outputs.package }}
          VERSION=${GITHUB_REF_NAME##*@v}
          echo "Publishing $PKG_PATH at version $VERSION"

          cd $PKG_PATH

          if [[ "$VERSION" == *-* ]]; then
            TAG=$(echo $VERSION | sed 's/^[0-9.]*-//' | cut -d. -f1)
            echo "Detected prerelease: tag=$TAG"
            npm publish --access public --tag "$TAG"
          else
            echo "Stable release"
            npm publish --access public --tag latest
          fi
