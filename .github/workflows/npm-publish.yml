name: Publish Angular Packages

on:
  push:
    tags:
      - 'utils@v*.*.*'
      - 'monaco-editor@v*.*.*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: npm ci

      - name: Extract package name from tag
        run: |
          REF=${GITHUB_REF_NAME}
          PACKAGE=${REF%%@v*}   # everything before "@v"
          echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV

      - name: Build the selected package
        run: npm run build $PACKAGE

      - name: Clean package.json before publishing
        run: |
          PKG_PATH=dist/@ng-catbee/$PACKAGE
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('$PKG_PATH/package.json', 'utf8'));
          delete pkg.devDependencies;
          delete pkg.scripts;
          fs.writeFileSync('$PKG_PATH/package.json', JSON.stringify(pkg, null, 2));
          console.log('Cleaned package.json for publish');
          "

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_PATH=dist/@ng-catbee/$PACKAGE
          VERSION=${GITHUB_REF_NAME##*@v}

          echo "Publishing package: $PKG_PATH"
          echo "Version: $VERSION"

          cd "$PKG_PATH"

          if [[ "$VERSION" == *-* ]]; then
            TAG=$(echo "$VERSION" | sed 's/^[0-9.]*-//' | cut -d. -f1)
            echo "Detected prerelease. Tag: $TAG"
            npm publish --access public --tag "$TAG"
          else
            echo "Stable release detected. Tag: latest"
            npm publish --access public --tag latest
          fi
