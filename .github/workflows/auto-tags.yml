name: Tag
run-name: Tag for ${{ github.repository }} on ${{ github.ref_name }}

on:
  push:
    branches:
      - main
    paths:
      - "packages/**/package.json"

permissions:
  contents: write
  statuses: write

jobs:
  detect:
    name: Detect Version Changes
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.version_changed }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if any version actually changed
        id: check
        run: |
          VERSION_CHANGED="false"

          for file in $(git diff --name-only HEAD~1 HEAD -- "packages/**/package.json"); do
            old=$(git show HEAD~1:"$file" | jq -r '.version')
            new=$(jq -r '.version' "$file")

            echo "Checking $file ... old=$old new=$new"

            if [ "$old" != "$new" ]; then
              VERSION_CHANGED="true"
            fi
          done

          echo "version_changed=$VERSION_CHANGED" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "Version changed? ${{ steps.check.outputs.version_changed }}"

  no-version-changes:
    name: Report No Version Changes
    needs: detect
    if: needs.detect.outputs.version_changed != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Report no version changes to commit
        uses: actions/github-script@v7
        env:
          TARGET_SHA: ${{ github.sha }}
        with:
          script: |
            const targetUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.TARGET_SHA,
              state: "success",
              context: "Tag",
              description: "No version changes",
              target_url: targetUrl
            });

  auto-tag:
    name: Create Tags for Version Bumps
    needs: detect
    if: needs.detect.outputs.version_changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed package.json files
        run: |
          git diff --name-only HEAD~1 HEAD -- "packages/**/package.json" > changed.txt

      - name: Create tags
        id: create_tags
        run: |
          CREATED=0
          CREATED_TAGS=""

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            folder=$(basename "$(dirname "$file")")
            new_version=$(jq -r '.version' "$file")
            old_version=$(git show HEAD~1:"$file" | jq -r '.version')

            if [ "$new_version" = "$old_version" ]; then
              echo "Version unchanged â†’ skipping tag"
              continue
            fi

            tag="${folder}@v${new_version}"
            echo "Creating tag: $tag"

            if git tag "$tag"; then
              CREATED=$((CREATED + 1))
              CREATED_TAGS="$CREATED_TAGS $tag"
            else
              echo "Tag already exists or failed"
            fi

          done < changed.txt

          echo "CREATED=$CREATED" >> $GITHUB_ENV
          echo "CREATED_TAGS=$CREATED_TAGS" >> $GITHUB_ENV

          if [ "$CREATED" -eq 0 ]; then
            echo "No tags were created"
          fi

      - name: Push tags
        if: env.CREATED != '0'
        run: git push --tags

      - name: Notify commit about created tags
        if: success()
        uses: actions/github-script@v7
        env:
          TARGET_SHA: ${{ github.sha }}
          CREATED_TAGS: ${{ env.CREATED_TAGS }}
        with:
          script: |
            const created = (process.env.CREATED_TAGS || "").trim();
            const formatted = created.split(" ").filter(Boolean).join(", ");

            const description = created
              ? `Created tags: ${formatted}`
              : "No tags were created";

            const targetUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: process.env.TARGET_SHA,
              state: "success",
              context: "Tag",
              description,
              target_url: targetUrl
            });

      - name: Trigger publish workflow when tags exist
        if: env.CREATED != '0'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: "publish_packages",
              client_payload: {
                tags: process.env.CREATED_TAGS,
                sha: process.env.GITHUB_SHA
              }
            });
